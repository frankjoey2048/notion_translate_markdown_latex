# Notion公式转换工具

> 初始代码源自：https://github.com/skyance/Notion-Formula-Auto-Conversion-Tool

## 更新日志

### 2025年8月7日 - v1.40
- **修复了公式过长渲染分块导致自动转换失败的问题**
  - 问题原因：Notion编辑器会将长公式文本分割成多个`<span>`元素，导致脚本无法识别完整公式
  - 解决方案：改进了文本选择算法，支持跨节点文本识别和选择
  - 新增了文本聚合功能，能够正确处理被分割的公式文本

### 之前版本
- 添加了中途停止转换功能
- 优化了拖动响应速度
- 改进了悬浮球交互体验

## 功能特点

- 🔄 自动批量转换Markdown格式公式为Notion原生公式
- 📐 支持多种公式格式：`$$...$$`（块公式）、`$...$`（行内公式）、`\(...\)`、`\[...\]`
- 🎯 悬浮球界面，可拖动调整位置
- ⏹️ 支持中途停止转换
- 📊 实时显示转换进度
- 🔍 自动检测页面中的公式数量

## 安装使用

### 1. 安装油猴插件

安装Tampermonkey浏览器扩展，并开启*开发者模式*（Chrome、Edge均支持，其中chrome还要在管理扩展程序/所有扩展程序/详情中开启*允许运行用户脚本*）

![image-20250513143909434](./assets/image-20250513143909434.png)

### 2. 添加脚本

1. 创建新脚本
2. 粘贴`correct.js`代码
3. `Ctrl+S`保存

![image-20250513144033632](./assets/image-20250513144033632.png)

### 3. 使用方法

1. 打开Notion页面，等待悬浮球出现
2. 鼠标悬停在悬浮球上查看检测到的公式数量
3. 点击"转换"按钮开始批量转换
4. 转换过程中尽量保持鼠标在页面内
5. 可点击"停止转换"中断操作

### 4. 效果展示

![20250513144310_rec_](./assets/20250513144310_rec_.gif)

## 注意事项

### 公式格式支持

- ✅ 行内公式：`$E=mc^2$`
- ✅ 块公式：`$$E=mc^2$$`
- ✅ LaTeX格式：`\(E=mc^2\)` 和 `\[E=mc^2\]`

### 已知限制

1. **块公式转换**：`$$...$$`格式会被转换为行内公式（Notion API限制）
   
   原始：
   ```
   $$
   E=mc^2
   $$
   ```
   
   期望效果：
   
   ![image-20250513162107570](./assets/image-20250513162107570.png)
   
   实际效果：
   
   ![image-20250513162125819](./assets/image-20250513162125819.png)

2. **跨区块限制**：如果`$$`符号不在同一个文本块中，可能无法正确识别

## 进阶技巧

### 将Notion安装为应用

Edge和Chrome支持将网页转换为应用，可获得更好的使用体验：

![image-20250513151347953](./assets/image-20250513151347953.png)

## 故障排除

### 常见问题

1. **公式无法识别**
   - 确保公式格式正确
   - 检查公式是否在同一文本块内
   - 尝试刷新页面后重试

2. **转换失败**
   - 某些复杂公式可能因包含特殊字符导致失败
   - 长公式已在v1.40版本修复
   - 如仍有问题，可尝试手动选择公式后转换

3. **悬浮球不显示**
   - 确认油猴脚本已启用
   - 检查是否在Notion页面（URL包含notion.so）
   - 刷新页面
